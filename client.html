<html>
<canvas id='screen' width='640' height='480' style='cursor: none;' />
<script src='game.js'></script>
<script src='ships.js'></script>
<script src='asteroids.js'></script>
<script src='bullets.js'></script>
<script src='smokes.js'></script>
<script src='collisions.js'></script>
<script src='body.js'></script>
<script src='tick.js'></script>

<script src='smoke.js'></script>
<script src='camera.js'></script>
<script src='screen.js'></script>
<script src='stars.js'></script>
<script src='keyboard.js'></script>
<script src='audio.js'></script>
<script>

  const screen = new Screen('screen')
  const stars = new Stars(0.0001)
  const kb = new Keyboard()
  // const audio = new Audio()
  const cam = new Camera()

  const game = new Game(1000)
  const stop = Tick(16, update, render)

  game.start()
  game.commit(new Action('join').set({
    playerId: 1,
    callsign: 'Amanda'
  }))

  kb.onChange((input, val) => {
    game.commit(new Action('input').set({
      playerId: 1,
      input: input,
      value: val,
    }))
  })

  function update(ms, time) {
    const state = game.commit(new Action('tick').set({ ms }))
    cam.update(ms, state, screen.width, screen.height)
  }

  function render(ms, time) {
    const frame = game.frame()
    screen.draw(ms, time, frame, cam, stars.points)
    // audio.play(ms, time, frame)
  }


  // const limit = 1000
  // const ship = new Ship(0, 0)
  // const cam = new Camera(ship)
  // const bullets = new Set()
  // const asteroids = new Set()


  // let lasteroid = 0

  // function update(ms, time) {
  //   if (false) {
  //     stop()
  //     return
  //   }
  //   if (asteroids.size < 50 && lasteroid < time - 500) {
  //     asteroids.add(new Asteroid(limit))
  //     lasteroid = time
  //   }
  //   ship.update(ms, time, kb.actions(), bullets, limit, smoke)
  //   bullets.forEach(b => {
  //     if (!b.update(ms, time)) bullets.delete(b)
  //   })
  //   asteroids.forEach(a => {
  //     if (!a.update(ms, limit)) asteroids.delete(a)
  //   })
  //   smoke.forEach(s => {
  //     if (!s.update(ms, time)) smoke.delete(s)
  //   })
  //   bullets.forEach(b => {
  //     asteroids.forEach(a => {
  //       if (b.body.hits(a.body)) {
  //         b.splash()
  //         a.hurt(1)
  //       }
  //     })
  //   })
  //   asteroids.forEach(a => {
  //     if (a.body.hits(ship.body)) {
  //       ship.damage(1)
  //     }
  //   })
  //   cam.update(ms, ship, limit, screen.width, screen.height)
  // }

  // function render(ms, time) {
  //   const sh = ship.frame()
  //   const bs = Array.from(bullets).map(b => b.frame())
  //   screen.draw(ms, time, sh, cam, bs, stars.frame(), asteroids, smoke)
  //   audio.play(ms, time, sh)
  // }

</script>

</html>