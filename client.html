<html>
<canvas id='screen' width='640' height='480' />
<script src='ship.js'></script>
<script src='camera.js'></script>
<script src='bullet.js'></script>
<script src='screen.js'></script>
<script src='stars.js'></script>
<script src='keyboard.js'></script>
<script src='audio.js'></script>
<script src='tick.js'></script>
<script src='asteroid.js'></script>
<script>

  main()

  function main() {
    const screen = new Screen('screen')
    const stars = new Stars(0.0001)
    const kb = new Keyboard()
    const audio = new Audio()

    const limit = 1000
    const ship = new Ship(0, 0)
    const cam = new Camera(ship.x, ship.y)
    const bullets = new Set()
    const asteroids = new Set()
    const stop = Tick(16, update, render)

    let lasteroid = 0

    function update(ms, time) {
      if (false) {
        stop()
        return
      }
      if (asteroids.size < 50 && lasteroid < time - 500) {
        asteroids.add(new Asteroid(limit))
        lasteroid = time
      }
      ship.update(ms, time, kb.actions(), bullets, limit)
      bullets.forEach(b => {
        if (!b.update(ms, time)) bullets.delete(b)
      })
      asteroids.forEach(a => {
        if (!a.update(ms, limit)) asteroids.delete(a)
      })
      bullets.forEach(b => {
        asteroids.forEach(a => {
          if (b.hits(a.x, a.y, a.size)) {
            b.splash()
            a.hurt(1)
          }
        })
      })
      cam.update(ms, ship, limit, screen.width, screen.height)
    }

    function render(ms, time) {
      const sh = ship.frame()
      const bs = Array.from(bullets).map(b => b.frame())
      screen.draw(ms, time, sh, cam, bs, stars.frame(), asteroids)
      audio.play(ms, time, sh)
    }
  }

</script>

</html>